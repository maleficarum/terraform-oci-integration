resource "oci_integration_integration_instance" "oic_instance" {
  compartment_id            = var.oic_definition.compartment
  display_name              = var.oic_definition.name
  integration_instance_type = var.oic_definition.instance_type
  is_byol                   = var.oic_definition.is_byol
  message_packs             = var.oic_definition.message_packs

  is_file_server_enabled    = var.oic_definition.is_file_server_enabled
  is_visual_builder_enabled = var.oic_definition.is_visual_builder_enabled
  state                     = var.oic_definition.state
  shape                     = var.oic_definition.shape

  #idcs_at = "eyJ4NXQjUzI1NiI6IkpmSUpXMHJOdnpwYXo3YjQxSDJiQVdaVTFrLTJBSHRoMjE5YzF4LU1yczAiLCJ4NXQiOiJxQXJRdE5YY1lSUzJmTEJKMk9Tb1hZUVlobXMiLCJraWQiOiJTSUdOSU5HX0tFWSIsImFsZyI6IlJTMjU2In0.eyJjbGllbnRfb2NpZCI6Im9jaWQxLmRvbWFpbmFwcC5vYzEubXgtcXVlcmV0YXJvLTEuYW1hYWFhYWF1bW5vd2hpYXhucGtvajcyb25hdnlpZWF3cmhzdmxwNnB4YW11ZGNyZXppbG42aGF0d3lxIiwic3ViIjoiYTEwZDFlOTBlMGU4NGYwZmE4OTA5MGEzNGU3ZTJlYWQiLCJzaWRsZSI6NDgwLCJ1c2VyLnRlbmFudC5uYW1lIjoiaWRjcy03OTA0YjA5ZDBkMmE0YzEzYTYzYTQzMDBkYWQxNjE3YyIsImlzcyI6Imh0dHBzOi8vaWRlbnRpdHkub3JhY2xlY2xvdWQuY29tLyIsImRvbWFpbl9ob21lIjoibXgtcXVlcmV0YXJvLTEiLCJjYV9vY2lkIjoib2NpZDEudGVuYW5jeS5vYzEuLmFhYWFhYWFhbDQ0eDY3Zm54dG9mNGJwbHFxZGlkaGlpNW16eDVzZDd4NGE2aGdxMnB2bWpjcHZzenVyYSIsImNsaWVudF9pZCI6ImExMGQxZTkwZTBlODRmMGZhODkwOTBhMzRlN2UyZWFkIiwiZG9tYWluX2lkIjoib2NpZDEuZG9tYWluLm9jMS4uYWFhYWFhYWFxaGo2dXhkamx2aXR5eGhjZWM0Z2wzZXBjb280Z3N5YjVkM296bXdpdG1wamhpamxkanFhIiwic3ViX3R5cGUiOiJjbGllbnQiLCJzY29wZSI6InVybjpvcGM6aWRtOnQuZGlnaXRhbGlkLnByb29mcHJvdmlkZXIgdXJuOm9wYzppZG06Zy5pZGVudGl0eXNvdXJjZXRlbXBsYXRlX3IgdXJuOm9wYzppZG06dC5hcHByb3ZhbHdvcmtmbG93IHVybjpvcGM6aWRtOnQuZ3JvdXBzLm1lbWJlcnMgdXJuOm9wYzppZG06dC5hcHAgdXJuOm9wYzppZG06dC51c2VyLmxvY2tlZHN0YXRlY2hhbmdlciB1cm46b3BjOmlkbTp0LnNlY3VyaXR5Y29uc2VudF9yIHVybjpvcGM6aWRtOnQuaWRicmlkZ2UuYWRtaW4gdXJuOm9wYzppZG06dC50ZXJtc29mdXNlIHVybjpvcGM6aWRtOnQuaWRjc3JwdHMgdXJuOm9wYzppZG06dC51c2VyLnNlY3JldGtleSB1cm46b3BjOmlkbTp0LnJlcXVlc3RzIHVybjpvcGM6aWRtOnQudXNlci5tYW5hZ2VyIHVybjpvcGM6aWRtOnQuZHJnIHVybjpvcGM6aWRtOnQuc2Vzc2lvbiB1cm46b3BjOmlkbTp0LmRpZ2l0YWxpZC5wcm9vZnRlbXBsYXRlIHVybjpvcGM6aWRtOnQuaGVscGRlc2suc2VjdXJpdHkgdXJuOm9wYzppZG06dC5zZWN1cml0eS5jbGllbnQgdXJuOm9wYzppZG06Zy5hcHB0ZW1wbGF0ZV9yIHVybjpvcGM6aWRtOnQuYnVsay51c2VyIHVybjpvcGM6aWRtOnQuZGlhZ25vc3RpY3NfciB1cm46b3BjOmlkbTp0LmlkYl9jb250YWluZXJzIHVybjpvcGM6aWRtOnQuaWRicmlkZ2UudXNlciB1cm46b3BjOmlkbTp0LnJhZGl1c3Byb3h5IHVybjpvcGM6aWRtOnQudXNlci5tZSB1cm46b3BjOmlkbTp0LmFkYXB0aXZlIHVybjpvcGM6aWRtOmcuYWxsX3IgdXJuOm9wYzppZG06dC51c2VyLnNlY3VyaXR5IHVybjpvcGM6aWRtOnQuam9iLnB1cmdlcmVzb3VyY2VzIHVybjpvcGM6aWRtOnQuZGlnaXRhbGlkLndhbGxldC5hbGxvd2xpc3QgdXJuOm9wYzppZG06dC5hdWRpdF9yIHVybjpvcGM6aWRtOnQuZGlnaXRhbGlkLnZjLnJldm9rZSB1cm46b3BjOmlkbTp0LmpvYi5hcHAgdXJuOm9wYzppZG06dC51c2VyLm1lLnBhc3N3b3JkdmFsaWRhdG9yIHVybjpvcGM6aWRtOnQuc29taSB1cm46b3BjOmlkbTpnLnNoYXJlZGZpbGVzIHVybjpvcGM6aWRtOnQuaGVscGRlc2sudXNlciB1cm46b3BjOmlkbTp0LnVzZXIuZGJjcmVkZW50aWFsIHVybjpvcGM6aWRtOnQucmVzLmltcG9ydGV4cG9ydCB1cm46b3BjOmlkbTp0LmpvYi5pZGVudGl0eSB1cm46b3BjOmlkbTp0LmN1c3RvbWNsYWltcyB1cm46b3BjOmlkbTp0LnNhbWwgdXJuOm9wYzppZG06dC5tZmEgdXJuOm9wYzppZG06dC5kYi5hZG1pbiB1cm46b3BjOmlkbTp0LnVzZXIuYXBpa2V5IHVybjpvcGM6aWRtOnQuc2NoZW1hcyB1cm46b3BjOmlkbTp0Lm1mYS51c2VyYWRtaW4gdXJuOm9wYzppZG06dC51c2VyLm1hbmFnZXIuam9iIHVybjpvcGM6aWRtOnQub2F1dGggdXJuOm9wYzppZG06dC5ncm91cHMgdXJuOm9wYzppZG06dC5qb2IuaW1wb3J0ZXhwb3J0IHVybjpvcGM6aWRtOnQuaWRicmlkZ2UudW5tYXBwZWQuaWRjc2F0dHJpYnV0ZXMgdXJuOm9wYzppZG06dC5kaWdpdGFsaWQuY3JlZHR5cGVjb25maWcgdXJuOm9wYzppZG06dC5rcmIuYWRtaW4gdXJuOm9wYzppZG06dC5uYW1lZGFwcGFkbWluIHVybjpvcGM6aWRtOnQuYmxrcnB0cyB1cm46b3BjOmlkbTp0LnNlbGZyZWdpc3RyYXRpb25wcm9maWxlIHVybjpvcGM6aWRtOnQudXNlci5hdXRoZW50aWNhdGUgdXJuOm9wYzppZG06dC5ncmFudHMgdXJuOm9wYzppZG06dC5vYXV0aHRva2VuIHVybjpvcGM6aWRtOnQuYXV0aGVudGljYXRpb24gdXJuOm9wYzppZG06dC5kaWdpdGFsaWQudmNsYWltcyB1cm46b3BjOmlkbTp0LmNvbnRhaW5lciB1cm46b3BjOmlkbTp0LmltYWdlcyB1cm46b3BjOmlkbTp0LmJ1bGsgdXJuOm9wYzppZG06dC51c2VyLm9hdXRoMmNsaWVudGNyZWQgdXJuOm9wYzppZG06dC5kZWxlZ2F0ZWQuZ3JvdXAubWVtYmVycyB1cm46b3BjOmlkbTp0LmpvYi5zZWFyY2ggdXJuOm9wYzppZG06dC5pZGJyaWRnZSB1cm46b3BjOmlkbTp0LmFwcHNlcnZpY2VzIHVybjpvcGM6aWRtOnQudXNlci5kYmxvZ2ludXBkYXRlciB1cm46b3BjOmlkbTp0LmRpZ2l0YWxpZC53YWxsZXQud2FsbGV0YXBwIHVybjpvcGM6aWRtOnQudXNlci5hdXRodG9rZW4gdXJuOm9wYzppZG06dC51c2VyLnNtdHBjcmVkZW50aWFsIHVybjpvcGM6aWRtOnQuc2V0dGluZ3MgdXJuOm9wYzppZG06dC51c2VyLm1hbmFnZXIuc2VjdXJpdHkgdXJuOm9wYzppZG06dC5kaWdpdGFsaWQudmMuc3RhdHVzIHVybjpvcGM6aWRtOnQuZGlnaXRhbGlkLmlzc3VlcmNvbmZpZyB1cm46b3BjOmlkbTp0LmFwcHJvdmFsd29ya2Zsb3cuYXNzaWdubWVudCB1cm46b3BjOmlkbTp0LmNsb3VkZ2F0ZSB1cm46b3BjOmlkbTp0LmlkYnJpZGdlLnNvdXJjZWV2ZW50IHVybjpvcGM6aWRtOnQuc3Vkb3JvbGUgdXJuOm9wYzppZG06dC51c2VyLmNhcGFiaWxpdGllc191IHVybjpvcGM6aWRtOnQucG9saWN5IHVybjpvcGM6aWRtOnQudXNlcnMgdXJuOm9wYzppZG06dC5yZXBvcnRzIHVybjpvcGM6aWRtOnQudXNlci5zdXBwb3J0YWNjb3VudCB1cm46b3BjOmlkbTp0LnNlc3Npb24ucmV2b2tlIHVybjpvcGM6aWRtOmcuaWRjc3JwdHNtZXRhX3IiLCJjbGllbnRfdGVuYW50bmFtZSI6ImlkY3MtNzkwNGIwOWQwZDJhNGMxM2E2M2E0MzAwZGFkMTYxN2MiLCJyZWdpb25fbmFtZSI6Im14LXF1ZXJldGFyby1pZGNzLTEiLCJleHAiOjE3NDYwMDEzOTYsImlhdCI6MTc0NTk5Nzc5NiwiY2xpZW50X2d1aWQiOiI4N2E0NDU0MTE4Zjk0YjllYjJhYmEyYjZjOWZlYWRjOSIsImNsaWVudF9uYW1lIjoib2ljLWFwcGxpY2F0aW9uIiwidGVuYW50IjoiaWRjcy03OTA0YjA5ZDBkMmE0YzEzYTYzYTQzMDBkYWQxNjE3YyIsImp0aSI6Ijk2OTNlYTQ0NWQ5ZTRlMjVhNzkyYTkxODNlYjc5NjNkIiwiZ3RwIjoiY2MiLCJvcGMiOmZhbHNlLCJzdWJfbWFwcGluZ2F0dHIiOiJ1c2VyTmFtZSIsInByaW1UZW5hbnQiOnRydWUsInRva190eXBlIjoiQVQiLCJhdWQiOlsiaHR0cHM6Ly9pZGNzLTc5MDRiMDlkMGQyYTRjMTNhNjNhNDMwMGRhZDE2MTdjLm14LXF1ZXJldGFyby1pZGNzLTEuc2VjdXJlLmlkZW50aXR5Lm9yYWNsZWNsb3VkLmNvbSIsImh0dHBzOi8vaWRjcy03OTA0YjA5ZDBkMmE0YzEzYTYzYTQzMDBkYWQxNjE3Yy5pZGVudGl0eS5vcmFjbGVjbG91ZC5jb20iLCJ1cm46b3BjOmxiYWFzOmxvZ2ljYWxndWlkPWlkY3MtNzkwNGIwOWQwZDJhNGMxM2E2M2E0MzAwZGFkMTYxN2MiXSwiY2FfbmFtZSI6InNpbmZvcm1leCIsImRvbWFpbiI6IkRlZmF1bHQiLCJjbGllbnRBcHBSb2xlcyI6WyJHbG9iYWwgVmlld2VyIiwiQXV0aGVudGljYXRlZCBDbGllbnQiLCJJZGVudGl0eSBEb21haW4gQWRtaW5pc3RyYXRvciJdLCJ0ZW5hbnRfaXNzIjoiaHR0cHM6Ly9pZGNzLTc5MDRiMDlkMGQyYTRjMTNhNjNhNDMwMGRhZDE2MTdjLmlkZW50aXR5Lm9yYWNsZWNsb3VkLmNvbTo0NDMifQ.YcTJwNVMShvriJC_ybcgexndyTYtkEo5Rp214iC6uB7xn7deYGgu7vCZBZzB1slRFbFa2S7lEHI0OkWGrNeLCaSZDPzKGM3iHLH0ySEtHmjnPnzap3O3wik5d0nFuAKpnccZNVpVtV8GupVhRCBWM618fXVsqGhXWfPb_V0HIn1QFjU1BUCU3BfRsuU0UdMUsN7fpe6LetqyeSPcs3jsn_FKsvwbXHQc85Q17VduEG394Xeh2iPdUorhnCcnC6gabmeCWjlecgaFRyF0dxgpAEUpmJKZ9o9M4mlI9ihyGJe6oJKv8OQfBDGPQkMRcHH7K1jmJTMehjXsUolbtdWVVQ"
  idcs_at = jsondecode(data.local_file.idcs_token.content)["access_token"]

  depends_on = [data.local_file.idcs_token]
}


resource "null_resource" "get_idcs_token" {  
  provisioner "local-exec" {
      command = <<EOT
        curl -X POST  ${var.idcs_domain}/oauth2/v1/token -H 'Authorization: Basic ${base64encode(format("%s:%s",var.idcs_client_id,var.idcs_client_secret))}' -d 'grant_type=client_credentials&scope=urn:opc:idm:__myscopes__' | jq '.' > token.tok
      EOT
  }

  triggers = {
    "build_number" = timestamp()
  }
}

#https://medium.com/oracledevs/provision-and-configure-oracle-integration-cloud-instance-using-terraform-6baa89c257a
/*


curl --location 'https://idcs-7904b09d0d2a4c13a63a4300dad1617c.identity.oraclecloud.com:443/oauth2/v1/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--header 'Authorization: Basic YTEwZDFlOTBlMGU4NGYwZmE4OTA5MGEzNGU3ZTJlYWQ6aWRjc2NzLTA1NWE5ODJmLWQ1ZDAtNDI4Yi1iODk0LTFkMTZkMjdmMjE0YQ==' \
--data-urlencode 'grant_type=client_credentials' \
--data-urlencode 'scope=urn:opc:idm:__myscopes__'
*/